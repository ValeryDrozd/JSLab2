<!DOCTYPE html>
<html>
<head>
	<title>
		
	</title>
	<link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body style="padding: 0;margin: 0;">

<nav style = "margin: 0;padding: 0; display:flex; width: 100%; height: 100%;">

	<div class="divBlock" id="buttonBlock" style="width:15%; background-color:black;">
	
	</div>
	
	<div class = "divBlock" style="width: 85%;flex-direction: column;background-color:yellow;height: 100vh;">
		<textarea id = "writeField" style="margin-top: 53px;">
		</textarea> 
	</div>
</nav>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</body>
<script type="text/javascript">

	let id;
	let keys;
	function router(elem){
		console.log($(elem).val());
		if($(elem).attr('id')=="createButton")window.location.replace("index.html");
		else
		window.location.replace("index.html?id="+$(elem).val());
	}

	//NEED COSMETICS CHANGES
	function createButton(data){
		return '<button id ="'+data['head']+'" class="blockButton" onclick = router(this) value="'+data['head']+'">'+data['head']+'<br>'+data['text'].substring(0,10)+'<br>'+data['data']+'</button><hr>';
	}

	//OK
	window.addEventListener('beforeunload', function(event) {
        let text = $("#writeField").val();
        let date = new Date();
        let head = text.trim();
        let ind;
        if(head=="" || text==localStorage.getItem(head))return;
        try{
        	ind = head.indexOf(' ',trimmed.indexOf(' ')+1);
        }
       	catch{
       		ind = 5;
       	}
       	console.log(ind);
        head = head.substring(0,5);
        let i = 1;
        while(localStorage.getItem(head)){
        	head+="("+i+")";
        }
        if(id==undefined){
        	keys.push(head);
        }
        else{
        	keys = keys.filter(function(index) {
        		return index!=id;
        	});
        	keys.push(head);
        }
        localStorage.setItem(head,JSON.stringify({"content":text,"date":date}));
        localStorage.setItem("all",JSON.stringify(keys));

    });
	
	//NOT OK
	(function () {
		 let queryString = window.location.search;
         const urlParams = new URLSearchParams(queryString);
         id = urlParams.get('id');
         let buttonList = '<button id="createButton" class="blockButton" onclick = "router(this)"> Create new Note </button><hr>';
  		 keys = JSON.parse(localStorage.getItem("all"));
  		 if(keys==null)keys = [];  		 
  		 for(var i = keys.length-1;i>=0;i--){
  		 	let data = JSON.parse(localStorage.getItem(keys[i]));
  		 	console.log(data);
  		 	buttonList+=createButton({"head":keys[i],"data":data["date"],"text":data["content"]});
  		 }
         $("#buttonBlock").html(buttonList);
         console.log(keys);
         if(id==undefined || id == ""){
         	$("#createButton").focus();
         }
         else{
         		console.log(id);
         		$("#"+id).focus();
         		$("#writeField").val(JSON.parse(localStorage.getItem(id))["content"]);
         	}
	})();
	

</script>
</html>